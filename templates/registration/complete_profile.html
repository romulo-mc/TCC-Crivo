{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center align-items-center py-5">
    <div class="col-md-10 col-lg-9">
        
        <div class="card shadow-lg border-0" style="border-radius: 30px; overflow: hidden;">
            <div class="row g-0">
                
                <div class="col-md-4 d-none d-md-flex flex-column align-items-center justify-content-start p-5" style="background-color: #fcfcfc;">
                    <div class="mt-5 text-center">
                        <div class="mb-3 position-relative d-inline-block">
                             <i class="bi bi-person-circle" style="font-size: 6rem; color: #ddd;"></i>
                        </div>
                        <h4 class="fw-bold text-dark">Olá, {{ user.first_name }}!</h4>
                        <p class="text-muted small">Vamos configurar seu perfil na comunidade.</p>
                    </div>
                </div>

                <div class="col-md-8 p-5" style="background-color: #F8F9FA;">
                    
                    <div class="progress mb-4" style="height: 6px; border-radius: 10px;">
                        <div class="progress-bar" role="progressbar" style="width: 50%; background-color: #90E0AA;"></div>
                        <div class="progress-bar" role="progressbar" style="width: 50%; background-color: #FFB684;"></div>
                    </div>

                    <h2 class="mb-4 fw-bold text-dark">Sobre Você</h2>

                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <h5 class="text-muted border-bottom pb-2 mb-3">Aparência</h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary">Foto de Perfil (Opcional)</label>
                            <div class="d-flex align-items-center gap-3">
                                <label for="id_foto" class="btn btn-outline-secondary" style="border-radius: 10px;">
                                    Escolher arquivo
                                </label>
                                <span class="text-muted small" id="nome_arquivo">Nenhum arquivo escolhido</span>
                                {{ form.foto }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary">Bio / Sobre mim (Opcional)</label>
                            {{ form.bio }}
                            <div class="form-check mt-2">
                                {{ form.show_bio }}
                                <label class="form-check-label text-muted" for="{{ form.show_bio.id_for_label }}">Tornar minha biografia pública no perfil</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary">Descrição Física (Opcional)</label>
                            {{ form.descricao_fisica }}
                            <div class="form-check mt-2">
                                {{ form.show_descricao_fisica }}
                                <label class="form-check-label text-muted" for="{{ form.show_descricao_fisica.id_for_label }}">Manter descrição física pública no perfil</label>
                            </div>
                        </div>

                        <h5 class="text-muted border-bottom pb-2 mb-3 mt-4">Identidade</h5>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-secondary">{{ form.genero.label }}</label>
                                {{ form.genero }}
                                
                                <div id="div_genero_outro" class="mt-2 d-none">
                                    {{ form.genero_outro }}
                                </div>
                                <div class="form-check mt-1">
                                    {{ form.show_genero }}
                                    <label class="form-check-label text-muted">Mostrar no perfil</label>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-secondary">{{ form.pronomes.label }}</label>
                                {{ form.pronomes }}
                                
                                <div id="div_pronomes_outro" class="mt-2 d-none">
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-lg" id="pronome_part1" placeholder="Ela" 
                                               style="border-top-left-radius: 15px; border-bottom-left-radius: 15px; background-color: #E0F0F5; border: none;" oninput="atualizarPronomeOculto()">
                                        <span class="input-group-text bg-white border-0 fw-bold">/</span>
                                        <input type="text" class="form-control form-control-lg" id="pronome_part2" placeholder="Dela" 
                                               style="border-top-right-radius: 15px; border-bottom-right-radius: 15px; background-color: #E0F0F5; border: none;" oninput="atualizarPronomeOculto()">
                                    </div>
                                    {{ form.pronomes_outro }}
                                </div>
                                <div class="form-check mt-1">
                                    {{ form.show_pronomes }}
                                    <label class="form-check-label text-muted">Mostrar no perfil</label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                             <div class="col-md-12 mb-3">
                                <label class="form-label fw-bold text-secondary">{{ form.data_nascimento.label }}</label>
                                {{ form.data_nascimento }}
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-secondary">{{ form.pais.label }}</label>
                                {{ form.pais }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold text-secondary">{{ form.estado.label }}</label>
                                {{ form.estado }}
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    {{ form.show_localizacao }}
                                    <label class="form-check-label text-muted">Mostrar a localização</label>
                                </div>
                            </div>
                        </div>

                        <h5 class="text-muted border-bottom pb-2 mb-3 mt-4">Relação com o tema (Obrigatório)</h5>
                        
                        <div class="p-3 rounded-4 mb-3" style="background-color: #f8f9fa; border: 1px solid #eee;">
                            
                            <div class="form-check mb-2">
                                {{ form.is_pcd }}
                                <label class="form-check-label fw-bold text-dark" for="{{ form.is_pcd.id_for_label }}">Sou Pessoa com Deficiência (PCD)</label>
                            </div>
                            <div class="mb-2 ms-4">
                                <label class="small text-muted">CID (Opcional)</label>
                                {{ form.cid }}
                            </div>

                            <hr>

                            <div class="form-check mb-2">
                                {{ form.is_profissional_saude }}
                                <label class="form-check-label fw-bold text-dark" for="{{ form.is_profissional_saude.id_for_label }}">Sou Profissional de Saúde</label>
                            </div>
                            <div class="ms-4 mb-3">
                                <div class="row g-2">
                                    <div class="col-12"><label class="small text-muted">Profissão</label>{{ form.profissao }}</div>
                                    <div class="col-6"><label class="small text-muted">Conselho</label>{{ form.conselho }}</div>
                                    <div class="col-6"><label class="small text-muted">Nº Registro</label>{{ form.registro_profissional }}</div>
                                    <div class="col-12"><label class="small text-muted">UF do Registro</label>{{ form.uf_registro }}</div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            {{ form.exibir_registro }}
                                            <label class="form-check-label small">Exibir registro publicamente (Selo Profissional)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr>

                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input" style="width: 1.3em; height: 1.3em;" id="check_aliado_trigger" onchange="toggleAliadoOptions(this)">
                                <label class="form-check-label fw-bold text-dark" for="check_aliado_trigger">Sou Aliado / Interessado</label>
                                <div class="d-none">{{ form.is_aliado }}</div>
                            </div>

                            <div id="aliado_options" class="ms-4 d-none">
                                <div class="form-check mb-1">{{ form.aliado_familiar }} <label class="form-check-label">Familiar / Cuidador</label></div>
                                <div class="form-check mb-1">{{ form.aliado_educador }} <label class="form-check-label">Educador / Pesquisador</label></div>
                                <div class="form-check mb-1">{{ form.aliado_estudante }} <label class="form-check-label">Estudante</label></div>
                                <div class="form-check mb-1">{{ form.aliado_apenas }} <label class="form-check-label">Apenas Aliado / Interessado</label></div>
                            </div>

                            <hr>

                            <div class="form-check mb-2">
                                {{ form.tema_prefiro_nao }}
                                <label class="form-check-label fw-bold text-muted" for="{{ form.tema_prefiro_nao.id_for_label }}">Prefiro não informar</label>
                            </div>

                        </div>

                        <div class="d-grid gap-2 mt-5">
                            <button type="submit" class="btn btn-lg fw-bold" style="background-color: #90E0AA; border-radius: 20px; color: #333;">
                                Finalizar Cadastro <i class="bi bi-check-circle-fill ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('id_foto').addEventListener('change', function(){
        var fileName = this.files[0] ? this.files[0].name : 'Nenhum arquivo escolhido';
        document.getElementById('nome_arquivo').textContent = fileName;
    });

    const paisSelect = document.getElementById('id_pais');
    const estadoSelect = document.getElementById('id_estado');

    function checkLocalizacao() {
        if (paisSelect.value && paisSelect.value !== 'BR') {
            estadoSelect.value = 'ESTR';
            
            estadoSelect.style.pointerEvents = 'none'; 
            estadoSelect.style.backgroundColor = '#e9ecef';
            estadoSelect.setAttribute('tabindex', '-1');
        } else {
            estadoSelect.style.pointerEvents = 'auto';
            estadoSelect.style.backgroundColor = '#E0F0F5';
            estadoSelect.removeAttribute('tabindex');
            
            if (estadoSelect.value === 'ESTR') {
                estadoSelect.value = '';
            }
        }
    }

    paisSelect.addEventListener('change', checkLocalizacao);
    document.addEventListener('DOMContentLoaded', checkLocalizacao);


    function toggleOutro(selectElement, divId) {
        var div = document.getElementById(divId);
        if (selectElement.value === 'OUTRO') {
            div.classList.remove('d-none');
        } else {
            div.classList.add('d-none');
        }
    }

    function atualizarPronomeOculto() {
        var p1 = document.getElementById('pronome_part1').value;
        var p2 = document.getElementById('pronome_part2').value;
        document.getElementById('id_pronomes_outro').value = p1 + "/" + p2;
    }

    function toggleAliadoOptions(trigger) {
        var optionsDiv = document.getElementById('aliado_options');
        var realField = document.getElementById('id_is_aliado');
        realField.checked = trigger.checked;

        if (trigger.checked) {
            optionsDiv.classList.remove('d-none');
            document.getElementById('id_tema_prefiro_nao').checked = false;
        } else {
            optionsDiv.classList.add('d-none');
            var checkboxes = optionsDiv.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
    }

    document.getElementById('id_tema_prefiro_nao').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('id_is_pcd').checked = false;
            document.getElementById('id_is_profissional_saude').checked = false;
            
            var checkAliado = document.getElementById('check_aliado_trigger');
            checkAliado.checked = false;
            toggleAliadoOptions(checkAliado);
        }
    });

    const triggersPrincipais = ['id_is_pcd', 'id_is_profissional_saude', 'check_aliado_trigger'];
    triggersPrincipais.forEach(id => {
        document.getElementById(id).addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('id_tema_prefiro_nao').checked = false;
            }
        });
    });
</script>
{% endblock %}